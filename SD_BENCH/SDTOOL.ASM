;I/O EFh
;7
;6 IN
;5 IN
;4 IN 
;3 IN 
;2 IN CTRL
;1 IN DATA1
;0 IN DATA0

;7
;6 OUT
;5 OUT
;4 OUT CTRL
;3 OUT
;2 OUT
;1 OUT DATA1
;0 OUT DATA0

;**** 2BIT受信 ****
;AレジスタBIT2、BIT3を受信する
RCV2BIT	PROC
RCV2BIT:
	CALL	F1CHK		;BIT1が0になるまでLOOP
	IN	A,(0EFH)	;JOYPORT0 -> A
	PUSH 	AF
	RES	4,A
	OUT	(0EFH),A	;BIT6 <- 0
	CALL	F2CHK		;BIT1が1になるまでLOOP
	SET	4,A
	OUT	(0EFH),A	;BIT6 <- 1
	POP 	AF
	AND	03H
	RET
ENDP

;**** 1BYTE受信 ****
;受信DATAを2BITずつ受信しAレジスタにセットしてリターン
RCVBYTE	PROC
RCVBYTE:
	PUSH	BC
	CALL	RCV2BIT
	LD	B,A
	CALL	RCV2BIT
	RLA
	RLA
	ADD	A,B
	LD	B,A
	CALL	RCV2BIT
	RLA
	RLA
	RLA
	RLA
	ADD	A,B
	LD	B,A
	CALL	RCV2BIT
	RLA
	RLA
	RLA
	RLA
	RLA
	RLA
	ADD	A,B
	CPL
	POP	BC
	RET
ENDP

;**** BUSYをCHECK(1) ****
; EFH BIT1が0になるまでLOP
F1CHK	PROC
F1CHK:	IN	A,(0EFH)
	AND	04H        	;BIT2 = 0?
	JR	NZ,F1CHK
	RET
ENDP

;**** BUSYをCHECK(0) ****
; EFH BIT1が1になるまでLOOP
F2CHK	PROC
F2CHK:	IN	A,(0EFH)
	AND	04H        	;BIT2 = 1?
	JR	Z,F2CHK
	RET
ENDP

;**** 1BYTE送信 ****
;Aレジスタの内容を下位2BITずつ送信
SNDBYTE	PROC
SNDBYTE:
	PUSH	BC
	CPL
	LD	B,A
	AND	03H
	CALL	SND2BIT
	LD	A,B
	AND	0CH
	RRA
	RRA
	CALL	SND2BIT
	LD	A,B
	AND	30H
	RRA
	RRA
	RRA
	RRA
	CALL	SND2BIT
	LD	A,B
	AND	0C0H
	RRA
	RRA
	RRA
	RRA
	RRA
	RRA
	CALL	SND2BIT
	POP	BC
	RET
ENDP

;**** 2BIT送信 ****
;AレジスタBIT0、BIT1を送信する
SND2BIT	PROC
SND2BIT:
	SET	4,A
	OUT	(0EFH),A
	RES	4,A
	OUT	(0EFH),A	;BIT6 <- 0
	CALL	F1CHK		;BIT1が0になるまでLOOP
	SET	4,A
	OUT	(0EFH),A	;BIT6 <- 1
	CALL	F2CHK
	RET
ENDP
